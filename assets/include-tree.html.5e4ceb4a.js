import{_ as r,r as t,o as D,c as i,b as s,e as a,w as n,d as e,a as p}from"./app.33ffcc50.js";const y={},d=s("h1",{id:"include-tree",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#include-tree","aria-hidden":"true"},"#"),e(" Include Tree")],-1),u=s("p",null,[e("When Coalesce maps from the your POCO objects that are returned from EF Core queries, it will follow a structure called an "),s("code",null,"IncludeTree"),e(" to determine what relationships to follow and how deep to go in re-creating that structure in the mapped DTOs.")],-1),C={class:"table-of-contents"},m=p(`<h2 id="purpose" tabindex="-1"><a class="header-anchor" href="#purpose" aria-hidden="true">#</a> Purpose</h2><p>Without an <code>IncludeTree</code> present, Coalesce will map the entire object graph that is reachable from the root object. This can often spiral out of control if there aren&#39;t any rules defining how far to go while turning this graph into a tree.</p><p>For example, suppose you had the following model with a many-to-many relationship (key properties omitted for brevity):</p><div class="language-c# line-numbers-mode" data-ext="c#"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">class</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">Employee</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#D4D4D4;">    [</span><span style="color:#4EC9B0;">ManyToMany</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Projects&quot;</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">ICollection</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">EmployeeProject</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">EmployeeProjects</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">static</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">IQueryable</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#DCDCAA;">WithProjectsAndMembers</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">db</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">ClaimsPrincipal</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">user</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Load all projects of an employee, as well as all members of those projects.</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">db</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employees</span></span>
<span class="line"><span style="color:#D4D4D4;">            .</span><span style="color:#DCDCAA;">Include</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeProjects</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">                .</span><span style="color:#DCDCAA;">ThenInclude</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Project</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeProjects</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">                .</span><span style="color:#DCDCAA;">ThenInclude</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employee</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">class</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">Project</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#D4D4D4;">    [</span><span style="color:#4EC9B0;">ManyToMany</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Employees&quot;</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">ICollection</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">EmployeeProject</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">EmployeeProjects</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">class</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">EmployeeProject</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">Employee</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">Project</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">Project</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, imagine that you have five employees and five projects, with every employee being a member of every project (i.e. there are 25 EmployeeProject rows).</p><p>Your client code makes a call to the Coalesce-generated API to load Employee #1 using the custom data source:</p>`,6),h=s("div",{class:"language-typescript line-numbers-mode","data-ext":"ts"},[s("pre",{class:"shiki",style:{"background-color":"#1E1E1E"}},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C586C0"}},"import"),s("span",{style:{color:"#D4D4D4"}}," { "),s("span",{style:{color:"#9CDCFE"}},"Employee"),s("span",{style:{color:"#D4D4D4"}}," } "),s("span",{style:{color:"#C586C0"}},"from"),s("span",{style:{color:"#D4D4D4"}}," "),s("span",{style:{color:"#CE9178"}},"'@/viewmodels.g'")]),e(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C586C0"}},"import"),s("span",{style:{color:"#D4D4D4"}}," { "),s("span",{style:{color:"#9CDCFE"}},"EmployeeViewModel"),s("span",{style:{color:"#D4D4D4"}}," } "),s("span",{style:{color:"#C586C0"}},"from"),s("span",{style:{color:"#D4D4D4"}}," "),s("span",{style:{color:"#CE9178"}},"'@/viewmodels.g'")]),e(`
`),s("span",{class:"line"}),e(`
`),s("span",{class:"line"},[s("span",{style:{color:"#569CD6"}},"var"),s("span",{style:{color:"#D4D4D4"}}," "),s("span",{style:{color:"#9CDCFE"}},"employee"),s("span",{style:{color:"#D4D4D4"}}," = "),s("span",{style:{color:"#569CD6"}},"new"),s("span",{style:{color:"#D4D4D4"}}," "),s("span",{style:{color:"#DCDCAA"}},"EmployeeViewModel"),s("span",{style:{color:"#D4D4D4"}},"();")]),e(`
`),s("span",{class:"line"},[s("span",{style:{color:"#9CDCFE"}},"employee"),s("span",{style:{color:"#D4D4D4"}},"."),s("span",{style:{color:"#9CDCFE"}},"$dataSource"),s("span",{style:{color:"#D4D4D4"}}," = "),s("span",{style:{color:"#569CD6"}},"new"),s("span",{style:{color:"#D4D4D4"}}," "),s("span",{style:{color:"#9CDCFE"}},"Employee"),s("span",{style:{color:"#D4D4D4"}},"."),s("span",{style:{color:"#9CDCFE"}},"DataSources"),s("span",{style:{color:"#D4D4D4"}},"."),s("span",{style:{color:"#DCDCAA"}},"WithProjectsAndMembers"),s("span",{style:{color:"#D4D4D4"}},"();")]),e(`
`),s("span",{class:"line"},[s("span",{style:{color:"#9CDCFE"}},"employee"),s("span",{style:{color:"#D4D4D4"}},"."),s("span",{style:{color:"#DCDCAA"}},"$load"),s("span",{style:{color:"#D4D4D4"}},"("),s("span",{style:{color:"#B5CEA8"}},"1"),s("span",{style:{color:"#D4D4D4"}},");")]),e(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),E=s("div",{class:"language-typescript line-numbers-mode","data-ext":"ts"},[s("pre",{class:"shiki",style:{"background-color":"#1E1E1E"}},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#569CD6"}},"var"),s("span",{style:{color:"#D4D4D4"}}," "),s("span",{style:{color:"#9CDCFE"}},"employee"),s("span",{style:{color:"#D4D4D4"}}," = "),s("span",{style:{color:"#569CD6"}},"new"),s("span",{style:{color:"#D4D4D4"}}," "),s("span",{style:{color:"#9CDCFE"}},"ViewModels"),s("span",{style:{color:"#D4D4D4"}},"."),s("span",{style:{color:"#DCDCAA"}},"Employee"),s("span",{style:{color:"#D4D4D4"}},"();")]),e(`
`),s("span",{class:"line"},[s("span",{style:{color:"#9CDCFE"}},"employee"),s("span",{style:{color:"#D4D4D4"}},"."),s("span",{style:{color:"#9CDCFE"}},"dataSource"),s("span",{style:{color:"#D4D4D4"}}," = "),s("span",{style:{color:"#569CD6"}},"new"),s("span",{style:{color:"#D4D4D4"}}," "),s("span",{style:{color:"#9CDCFE"}},"employee"),s("span",{style:{color:"#D4D4D4"}},"."),s("span",{style:{color:"#9CDCFE"}},"dataSources"),s("span",{style:{color:"#D4D4D4"}},"."),s("span",{style:{color:"#DCDCAA"}},"WithProjectsAndMembers"),s("span",{style:{color:"#D4D4D4"}},"();")]),e(`
`),s("span",{class:"line"},[s("span",{style:{color:"#9CDCFE"}},"employee"),s("span",{style:{color:"#D4D4D4"}},"."),s("span",{style:{color:"#DCDCAA"}},"load"),s("span",{style:{color:"#D4D4D4"}},"("),s("span",{style:{color:"#B5CEA8"}},"1"),s("span",{style:{color:"#D4D4D4"}},");")]),e(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),v=s("p",null,[e("If you're already familiar with the fact that an "),s("code",null,"IncludeTree"),e(" is implicitly created in this scenario, then imagine for a moment that this is not the case (if you're not familiar with this fact, then keep reading!).")],-1),b=s("code",null,"DbContext",-1),F=p(`<p>To map these objects to DTOs, we start with the root (employee #1) and expand outward from there until the entire object graph has been faithfully re-created with DTO objects, including all navigation properties.</p><p>The root DTO object (employee #1) then eventually is passed to the JSON serializer by ASP.NET Core to formulate the response to the request. As the object is serialized to JSON, the only objects that are not serialized are those that were already serialized as an ancestor of itself. What this ultimately means is that the structure of the serialized JSON with our example scenario ends up following a pattern like this (the vast majority of items have been omitted):</p><div class="language-text" data-ext="text"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">Employee#1</span></span>
<span class="line"><span style="color:#D4D4D4;">    EmployeeProject#1</span></span>
<span class="line"><span style="color:#D4D4D4;">        Project#1</span></span>
<span class="line"><span style="color:#D4D4D4;">            EmployeeProject#6</span></span>
<span class="line"><span style="color:#D4D4D4;">                Employee#2</span></span>
<span class="line"><span style="color:#D4D4D4;">                    EmployeeProject#7</span></span>
<span class="line"><span style="color:#D4D4D4;">                        Project#2</span></span>
<span class="line"><span style="color:#D4D4D4;">                            ... continues down through all remaining employees and projects.</span></span>
<span class="line"><span style="color:#D4D4D4;">                    ...</span></span>
<span class="line"><span style="color:#D4D4D4;">            EmployeeProject#11</span></span>
<span class="line"><span style="color:#D4D4D4;">                Employee#3</span></span>
<span class="line"><span style="color:#D4D4D4;">            ...</span></span>
<span class="line"><span style="color:#D4D4D4;">    EmployeeProject#2</span></span>
<span class="line"><span style="color:#D4D4D4;">        Project#2</span></span>
<span class="line"><span style="color:#D4D4D4;">    ...</span></span>
<span class="line"><span style="color:#D4D4D4;"></span></span></code></pre></div><p>See how the structure includes the EmployeeProjects of Employee#2? We didn&#39;t write our custom data source calls to <code>.Include</code> in such a way that indicated that we wanted the root employee, their projects, the employees of those projects, and then <strong>the projects of those employees</strong>. But, because the JSON serializer blindly follows the object graph, that&#39;s what gets serialized. It turns out that the depth of the tree increases on the order of <code>O(n^2)</code>, and the total size increases on the order of <code>Ω(n!)</code>.</p><p>This is where <code>IncludeTree</code> comes in. When you use a custom data source like we did above, Coalesce automatically captures the structure of the calls to <code>.Include</code> and <code>.ThenInclude</code>, and uses this to perform trimming during creation of the DTO objects.</p><p>With an <code>IncludeTree</code> in place, our new serialized structure looks like this:</p><div class="language-text" data-ext="text"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">Employee#1</span></span>
<span class="line"><span style="color:#D4D4D4;">    EmployeeProject#1</span></span>
<span class="line"><span style="color:#D4D4D4;">        Project#1</span></span>
<span class="line"><span style="color:#D4D4D4;">            EmployeeProject#6</span></span>
<span class="line"><span style="color:#D4D4D4;">                Employee#2</span></span>
<span class="line"><span style="color:#D4D4D4;">            EmployeeProject#11</span></span>
<span class="line"><span style="color:#D4D4D4;">                Employee#3</span></span>
<span class="line"><span style="color:#D4D4D4;">            ...</span></span>
<span class="line"><span style="color:#D4D4D4;">    EmployeeProject#2</span></span>
<span class="line"><span style="color:#D4D4D4;">        Project#2</span></span>
<span class="line"><span style="color:#D4D4D4;">    ...</span></span>
<span class="line"><span style="color:#D4D4D4;"></span></span></code></pre></div><p>No more extra data trailing off the end of the projects&#39; employees!</p><h2 id="usage" tabindex="-1"><a class="header-anchor" href="#usage" aria-hidden="true">#</a> Usage</h2><h3 id="custom-data-sources" tabindex="-1"><a class="header-anchor" href="#custom-data-sources" aria-hidden="true">#</a> Custom Data Sources</h3>`,10),g=s("code",null,"IncludeTree",-1),f=s("code",null,".Include",-1),_=s("code",null,".ThenInclude",-1),A=s("code",null,"IncludeTree",-1),w=p(`<p>However, there are sometimes cases where you perform complex loading in these methods that involves loading data into the current <code>DbContext</code> outside of the <code>IQueryable</code> that is returned from the method. The most common situation for this is needing to conditionally load related data - for example, load all children of an object where the child has a certain value of a Status property.</p><p>In these cases, Coalesce provides a pair of extension methods, <code>.IncludedSeparately</code> and <code>.ThenIncluded</code>, that can be used to merge in the structure of the data that was loaded separately from the main <code>IQueryable</code>.</p><p>For example:</p><div class="language-c# line-numbers-mode" data-ext="c#"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">override</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">IQueryable</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#DCDCAA;">GetQuery</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Load all projects that are complete, and their members, into the db context.</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">Db</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Projects</span></span>
<span class="line"><span style="color:#D4D4D4;">        .</span><span style="color:#DCDCAA;">Include</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">p</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">p</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeProjects</span><span style="color:#D4D4D4;">).</span><span style="color:#DCDCAA;">ThenInclude</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employee</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        .</span><span style="color:#DCDCAA;">Where</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">p</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">p</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Status</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">ProjectStatus</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Complete</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        .</span><span style="color:#DCDCAA;">Load</span><span style="color:#D4D4D4;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Return an employee query, and notify Coalesce that we loaded the projects in a different query.</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">Db</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employees</span></span>
<span class="line"><span style="color:#D4D4D4;">        .</span><span style="color:#DCDCAA;">IncludedSeparately</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeProjects</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        .</span><span style="color:#DCDCAA;">ThenIncluded</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Project</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeProjects</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        .</span><span style="color:#DCDCAA;">ThenIncluded</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employee</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),I=s("code",null,"GetIncludeTree",-1),j=p(`<div class="language-c# line-numbers-mode" data-ext="c#"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">override</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">IncludeTree</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">GetIncludeTree</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">IQueryable</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">T</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">query</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">IDataSourceParameters</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">parameters</span><span style="color:#D4D4D4;">) =&gt; </span><span style="color:#9CDCFE;">Db</span></span>
<span class="line"><span style="color:#D4D4D4;">    .</span><span style="color:#9CDCFE;">Employees</span></span>
<span class="line"><span style="color:#D4D4D4;">    .</span><span style="color:#DCDCAA;">IncludedSeparately</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeProjects</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    .</span><span style="color:#DCDCAA;">ThenIncluded</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Project</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeProjects</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    .</span><span style="color:#DCDCAA;">ThenIncluded</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">ep</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employee</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    .</span><span style="color:#DCDCAA;">GetIncludeTree</span><span style="color:#D4D4D4;">(); </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="model-methods" tabindex="-1"><a class="header-anchor" href="#model-methods" aria-hidden="true">#</a> Model Methods</h3>`,2),T=s("code",null,"IncludeTree",-1),x=s("code",null,"IncludeTree",-1),P={class:"custom-container tip"},B=s("p",{class:"custom-container-title"},"TIP",-1),k=s("p",null,[e("An "),s("code",null,"IncludeTree"),e(" can be obtained from any "),s("code",null,"IQueryable"),e(" by calling the "),s("code",null,"GetIncludeTree"),e(" extension method ("),s("code",null,"using IntelliTect.Coalesce.Helpers.IncludeTree"),e(").")],-1),S=s("code",null,"DbContext",-1),O=s("code",null,"Enumerable.Empty<MyNonDbClass>().AsQueryable()",-1),M=s("code",null,"IQueryable",-1),q=s("strong",null,"must",-1),z=s("code",null,"IncludedSeparately",-1),N=s("code",null,"Include",-1),W=s("code",null,"DbSet",-1),Q=p(`<p>See the following two techniques for returning an <code>IncludeTree</code> from a custom method:</p><h4 id="itemresult-includetree" tabindex="-1"><a class="header-anchor" href="#itemresult-includetree" aria-hidden="true">#</a> ItemResult.IncludeTree</h4><p>The easiest and most versatile way to return an <code>IncludeTree</code> from a custom method is to make that method return an <code>ItemResult&lt;T&gt;</code>, and then set the <code>IncludeTree</code> property of the <code>ItemResult</code> object. For example:</p><div class="language-c# line-numbers-mode" data-ext="c#"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">class</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">Employee</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">async</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">Task</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">ItemResult</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">ICollection</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt;&gt;&gt; </span><span style="color:#DCDCAA;">GetChainOfCommand</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">db</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#4EC9B0;">IQueryable</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">query</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">db</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employees</span></span>
<span class="line"><span style="color:#D4D4D4;">            .</span><span style="color:#DCDCAA;">Include</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Supervisor</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">ret</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">new</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">List</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt;();</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">current</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">this</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">while</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">current</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Supervisor</span><span style="color:#D4D4D4;"> != </span><span style="color:#569CD6;">null</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        {</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#9CDCFE;">ret</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Push</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">current</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#9CDCFE;">current</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">await</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">query</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">FirstOrDefaultAsync</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeId</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">current</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">SupervisorId</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">new</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">ret</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">includeTree</span><span style="color:#D4D4D4;">: </span><span style="color:#9CDCFE;">query</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">GetIncludeTree</span><span style="color:#D4D4D4;">());</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="out-parameter" tabindex="-1"><a class="header-anchor" href="#out-parameter" aria-hidden="true">#</a> Out Parameter</h4><p>To tell Coalesce about the structure of the data returned from a model method, you can also add <code>out IncludeTree includeTree</code> to the signature of the method. Inside your method, set <code>includeTree</code> to an instance of an <code>IncludeTree</code>. However, this approach cannot be used on <code>async</code> methods, since <code>out</code> parameters are not allowed on async methods in C#. For example:</p><div class="language-c# line-numbers-mode" data-ext="c#"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">class</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">Employee</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">ICollection</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#DCDCAA;">GetChainOfCommand</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">db</span><span style="color:#D4D4D4;">, </span><span style="color:#569CD6;">out</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">IncludeTree</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">includeTree</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#4EC9B0;">IQueryable</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">query</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">db</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employees</span></span>
<span class="line"><span style="color:#D4D4D4;">            .</span><span style="color:#DCDCAA;">Include</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Supervisor</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">ret</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">new</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">List</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt;();</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">current</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">this</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">while</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">current</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Supervisor</span><span style="color:#D4D4D4;"> != </span><span style="color:#569CD6;">null</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        {</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#9CDCFE;">ret</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Push</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">current</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#9CDCFE;">current</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">query</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">FirstOrDefault</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeId</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">current</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">SupervisorId</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">includeTree</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">query</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">GetIncludeTree</span><span style="color:#D4D4D4;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">ret</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="external-type-caveats" tabindex="-1"><a class="header-anchor" href="#external-type-caveats" aria-hidden="true">#</a> External Type Caveats</h3>`,8),G=s("code",null,"IncludeTree",-1),L=s("p",null,"By not filtering unmapped properties, you as the developer don't need to account for them in every place throughout your application where they appear - instead, they 'just work' and show up on the client as expected.",-1),R=s("p",null,[e("Note also that this statement does not apply to database-mapped objects that hang off of unmapped objects - any time a database-mapped object appears, it will be controlled by your include tree. If no include tree is present (because nothing was specified for the unmapped property), these mapped objects hanging off of unmapped objects will be serialized freely and with all circular references, unless you include some calls to "),s("code",null,".IncludedSeparately(m => m.MyUnmappedProperty.MyMappedProperty)"),e(" to limit those objects down.")],-1);function V(J,H){const o=t("router-link"),c=t("CodeTabs"),l=t("RouterLink");return D(),i("div",null,[d,u,s("nav",C,[s("ul",null,[s("li",null,[a(o,{to:"#purpose"},{default:n(()=>[e("Purpose")]),_:1})]),s("li",null,[a(o,{to:"#usage"},{default:n(()=>[e("Usage")]),_:1}),s("ul",null,[s("li",null,[a(o,{to:"#custom-data-sources"},{default:n(()=>[e("Custom Data Sources")]),_:1})]),s("li",null,[a(o,{to:"#model-methods"},{default:n(()=>[e("Model Methods")]),_:1})]),s("li",null,[a(o,{to:"#external-type-caveats"},{default:n(()=>[e("External Type Caveats")]),_:1})])])])])]),m,a(c,null,{vue:n(()=>[h]),knockout:n(()=>[E]),_:1}),v,s("p",null,[e("After Coalesce has called your "),a(l,{to:"/modeling/model-components/data-sources.html"},{default:n(()=>[e("Data Sources")]),_:1}),e(" and evaluated the EF IQueryable returned, there are now 35 objects loaded into the current "),b,e(" being used to handle this request - the 5 employees, 5 projects, and 25 relationships.")]),F,s("p",null,[e("In most cases, you don't have to worry about creating an "),g,e(". When using the "),a(l,{to:"/modeling/model-components/data-sources.html#standard-data-source"},{default:n(()=>[e("Standard Data Source")]),_:1}),e(" (or a derivative), the structure of the "),f,e(" and "),_,e(" calls will be captured automatically and be turned into an "),A,e(".")]),w,s("p",null,[e("You can also override the "),I,e(" method of the "),a(l,{to:"/modeling/model-components/data-sources.html#standard-data-source"},{default:n(()=>[e("Standard Data Source")]),_:1}),e(" to achieve the same result:")]),j,s("p",null,[e("If you have "),a(l,{to:"/modeling/model-components/methods.html"},{default:n(()=>[e("custom methods")]),_:1}),e(" that return object data, you may also want to control the structure of the returned data when it is serialized. Fortunately, you can also use "),T,e(" in these situations. Without an "),x,e(", the entire object graph is traversed and serialized without limit.")]),s("div",P,[B,k,s("p",null,[e("In situations where your root object isn't on your "),S,e(" (see "),a(l,{to:"/modeling/model-types/external-types.html"},{default:n(()=>[e("External Types")]),_:1}),e("), you can use "),O,e(" to get an "),M,e(" to start from. When you do this, you "),q,e(" use "),z,e(" - the regular EF "),N,e(" method won't work without a "),W,e(".")])]),Q,s("p",null,[e("One important point remains regarding "),G,e(" - it is not used to control the serialization of objects which are not mapped to the database, known as "),a(l,{to:"/modeling/model-types/external-types.html"},{default:n(()=>[e("External Types")]),_:1}),e(". External Types are always put into the DTOs when encountered (unless otherwise prevented by "),a(l,{to:"/modeling/model-components/attributes/dto-includes-excludes.html"},{default:n(()=>[e("[DtoIncludes] & [DtoExcludes]")]),_:1}),e(" or "),a(l,{to:"/modeling/model-components/attributes/security-attribute.html"},{default:n(()=>[e("Security Attributes")]),_:1}),e("), with the assumption that because these objects are created by you (as opposed to Entity Framework), you are responsible for preventing any undesired circular references.")]),L,R])}const Y=r(y,[["render",V],["__file","include-tree.html.vue"]]);export{Y as default};
